@{
    ViewData["Title"] = "Configurações da página de recuperação de senha";
}

<header class="header header-sticky p-0 mb-4">
    <div class="container-fluid px-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb my-0">
                <li class="breadcrumb-item">
                    <a asp-controller="Home" asp-action="Index">Início</a>
                </li>
                <li class="breadcrumb-item active">
                    <span>Configurações</span>
                </li>
                <li class="breadcrumb-item active">
                    <span>Senha</span>
                </li>
            </ol>
        </nav>
    </div>
</header>

<div class="container-lg px-4">
    <div class="card mb-4">
        <div class="card-header"><strong>@ViewData["Title"]</strong></div>
        <div class="card-body">
            <form id="formSenha" enctype="multipart/form-data" asp-action="Password" asp-controller="Settings" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <!-- Link direto -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Link: </label>
                    <a href="https://localhost:7248/Account/ForgotPassword" target="_blank">
                        https://localhost:7248/Account/ForgotPassword
                    </a>
                </div>

                <div class="row mb-3 align-items-end">
                    <!-- Logo -->
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Logo da página</label>
                        <input class="form-control" type="file" accept="image/*" id="formFile" name="logoFile" onchange="previewLogo(event)">
                    </div>

                    <!-- Cor principal -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Cor principal</label>
                        <input type="color" id="colorBackground" name="primaryColor"
                               class="form-control form-control-color w-100"
                               value="#008b8b"
                               title="Cor principal"
                               onchange="updatePreviewColors()">
                    </div>

                    <!-- Cor secundária -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Cor secundária</label>
                        <input type="color" id="colorButton" name="secundaryColor"
                               class="form-control form-control-color w-100"
                               value="#66cdaa"
                               title="Cor secundária"
                               onchange="updatePreviewColors()">
                    </div>
                </div>
            </form>


            <!-- Preview -->
            <div class="mb-3">
                <h6><strong>Pré-visualização: </strong></h6>
                <iframe src="/Account/PasswordPreview"
                        id="previewIframe"
                        style="
                        width: 780px;
                        height: 360px;
                        border: none;
                        border-radius: 8px;
                        background: #f5f5f5;
                        display: block;
                        margin: 0 auto;
                    ">
                </iframe>
            </div>
        </div>

        <div class="form-group modal-footer">
            <input type="submit" form="formSenha" value="Salvar" class="btn btn-success" />
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Atualiza o preview da logo dentro do iframe
        function previewLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function () {
                const iframe = document.getElementById('previewIframe');
                const logo = iframe.contentDocument?.querySelector('.left .logo');

                if (logo) {
                    logo.style.backgroundImage = `url(${reader.result})`;
                    logo.style.backgroundSize = 'contain';
                    logo.style.backgroundRepeat = 'no-repeat';
                    logo.style.backgroundPosition = 'center';
                }
            };
            reader.readAsDataURL(file);
        }

        // Atualiza as cores dentro do iframe
        function updatePreviewColors() {
            const iframe = document.getElementById('previewIframe');
            const bgColor = document.getElementById('colorBackground').value;
            const btnColor = document.getElementById('colorButton').value;

            const left = iframe.contentDocument?.querySelector('.left');
            const button = iframe.contentDocument?.querySelector('.right form button');

            if (left)
                left.style.background = `linear-gradient(to bottom, ${bgColor}, ${btnColor})`;

            if (button)
                button.style.background = `linear-gradient(to right, ${btnColor}, ${bgColor})`;
        }

        // Aplica configurações iniciais assim que o iframe carregar
        function applyPreviewSettings() {
            updatePreviewColors();

            // Tenta aplicar logo já selecionada (caso o usuário altere antes do load completo)
            const fileInput = document.getElementById('formFile');
            if (fileInput.files.length > 0) {
                previewLogo({ target: fileInput });
            }
        }
    </script>
}
